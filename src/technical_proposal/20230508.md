---
# icon: lock
date: 2023-05-09
category:
  - 技术方案
tag:
  - 前端
  - 技术方案
  - vue
---

# [20230508]优化需求

## **需求分析**

本期需求原型参考“飞尔 ERP 系统 1.8 2023.05.08”，需求文档参考：

[2023.05.08-优化需求](https://alidocs.dingtalk.com/i/nodes/20eMKjyp81KgKGbyugDXPznoVxAZB1Gv)

[2023.05.08 优化需求](https://alidocs.dingtalk.com/i/nodes/ZX6GRezwJlP5Padri1BxxKblJdqbropQ)

本期@赖喜铃主要负责：线下费用-设置收费标准、线下费用-可配置化通用费用模块优化、往期遗留的“POD 文件上传”、“税金文件上传”需求，以及部分往期遗留的优化需求。

## **业务、功能分析**

### **线下费用-设置收费标准**

在原有逻辑中，收费标准添加后就不能修改，现在需求变更为，添加后的收费标准记录，可以单个编辑，点击确定后才会把修改后的数据提交至后端处理。

![img](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/BKM7qeMEvYm7qpj8/img/19ed01d8-9b02-445c-ab2f-2699832aeb58.png)

现需求变更，需要考虑细节如下：

- **业务逻辑调整**

由原有行编辑变更为单元格可编辑，需要在数据的 dom 节点上增加逻辑，鼠标悬浮出现可编辑的提示，用户点击即可进行编辑，编辑后点击确定才能保存或失去焦点才能保存。

- **页面结构调整**

每个单元格插槽都需要可编辑的交互，原先使用的是系统封装好的 table-page 组件，则需要在每一列都插上 input 插槽，鼠标悬浮后提示可编辑标识，点击后显示输入框，并将原有数据填充进 input。

需要在 table-page 组件插入 template#column 插槽，具体插槽为遍历每一个列配置即可。

- **数据结构调整**

首先是临时数据，当用户编辑单元格时，需要先将原有数据保存为一个临时数据，用户修改时修改的是临时数据，确认修改时才把修改后的临时数据替换为原有数据，若是放弃修改，则将临时数据放弃，保留原有数据。

因此，需要新增的数据有：

el-input 输入框控件，临时单元格数据 tempCellData，控制是否显示输入框 isEditable，

### **线下费用-可配置化通用费用模块**

1. **批量设置费用付点数限制至小数点后四位**

原有配置仅限制了：8 位整数 2 位小数、8 位整数 8 位小数、6 位整数 2 位小数、6 位整数 8 位小数，现根据新需求，需要新增限制 4 位小数，即新增限制函数：8 位整数 4 位小数、6 位整数 4 位小数。

此部分即在原有基础上复制并调整参数，但是需要注意自测。

1. **批量设置费用新增校验功能**

部分通用费用模块需要做好检验，如果存在编辑多个费用，两者必填其一，否则不予点击“确定”，需要前端做判断，并在不符合要求时将“确定”按钮置灰。

如何知道哪部分需要做类似的校验则需要后端返回字段，前端判断是否需要校验，若需要则做如上校验动作，若不需要则保留原有逻辑即可。

1. **链接查邮箱新增记录时做校验动作**

在链接查邮箱 tab 中，新增记录时，用户填写数据完毕后，点击确定，此时由后端检索是否已存在相同的记录，若存在则不予提交成功，并保留弹窗打开状态。

此功能需要前端做好关闭弹窗的动作顺序，等后端返回无误后再关闭弹窗并刷新页面，否则不关闭添加弹窗并报错。

1. **批量设置费用支持新公式**

这部分需要后端先行，再具体确定是否需要前端新增控件以支持新的公式。

### **文件上传**

往期遗留的两个上传：POD 文件上传、税金文件上传功能搁置至今，本期需要完成该需求。

由于两个功能共性极高，因此实现这两个功能仅需要创建一个组件，做好标识判断是不同的功能即可。

该功能需要弹窗组件、上传组件的支持，具体实现可以参考往期的上传组件，根据实际需求做一定的修改、调用指定的接口即可。

### **部分遗留优化需求**

具体情况未定，需要先把前面的功能实现后根据剩余时间再灵活安排优化任务。

### **线上 bug 解决**

此部分为最优先事项，若是线上出现问题，第一时间解决。

## **技术分析**

### **线下费用-设置收费标准**

- **页面结构**

每个单元格新增一个编辑的 icon，鼠标移入展示，利用好 tailwindCss，即可实现鼠标移入显示；

icon 需要添加一个方法，该方法点击后可在鼠标移入的单元格显示输入框控件，并将原有数据填充进输入框；

输入框后再加一个取消按钮，点击该按钮则取消编辑，隐藏输入框并还原原有数据，若点击其他地方则保存修改后的数据；

- **数据结构调整**

新增 tempCellData 变量保存原有单元格数据，每次点击不同单元则修改为当前单元格的数据；

新增保存修改数据的方法：onChange 和放弃修改的方法 cancelEdit；

修改提交给后端的数据结构，若涉及合并的列，每一合并的数据列添加对应的数据：

1. kickback_unified_signal：1 合并，0 非合并
2. picture_video_unified_signal：1 合并，0 非合并
3. remark_unified_signal：1 合并，0 非合并

### 线下费用-可配置化通用费用

1. **批量设置费用付点数限制至小数点后四位**

el-input 支持原生 input 的方法 oninput，该方法每次输入时触发，结合正则表达式，利用 js 的字符串替换 replace 方法，检测每次输入的值是否符合正则表达式，是的话则输入，不是的话则替换为空即可；

在之前的许多创建/编辑页面都有写过这个方法，借鉴其方法并根据实际需求调整参数即可；

1. **批量设置费用新增校验功能**

首先需要判断当前 tab 的批量编辑费用是否需要检验，若需要，则遍历费用项，只要有一项不为空即可点击确认，否则不可点击。

遍历的方法可使用 find、some 或 filter，灵活变通使用即可。

1. **链接查邮箱新增记录时做校验动作**

用户添加记录时，数据填写完毕，点击确认，前端调用创建接口，等待后端返回；

后端检查该通用费用 tab 的 list 数据是否已经存在某条正在添加的记录，若存在，则报错提示，前端判断后端返回是否存在 err 信息，若存在，则不予通过，并保持弹窗打开状态即可，否则添加成功，关闭弹窗。

1. **批量设置费用支持新公式**

此部分需要等待后端配置完成后，前端调用后端接口，查看当前配置是否满足场景，若不满足则需要根据实际情况进行调整配置以支持新公式。

### **文件上传**

涉及 POD 文件上传与税金文件上传，定义好不同的标识，例如：pod 文件为 mode=pod，税金文件 mode=tax，根据标识不同来渲染不同的标题、文件信息、调用不同的接口。

若列表中已存在文件，则需要把现有的文件保存并渲染到上传弹窗中，供用户进行更新操作。

## **具体实施**

### 线下费用-设置收费标准

```
// 具体代码查看：
// erp_fe/src/views/offlineExpensesManage/offlineExpenses
//	-> /components/ChargeDialog/index.vue
```

### 线下费用-可配置化通用费用模块

- **小数点限制后四位：**

```ts
const onInput = (val: Record<string, any>) => {
  // ....
  if (props?.regExp == 'six_int_four_dec') {
    val.target.value =
      val.target.value
        .replace(/\D*(\d*)(\.?)(\d{0,3})\d*/, '$1$2$3')
        .replace(/^0+(\d)/, '$1')
        .replace(/^\./, '0.')
        .replace(/^\D*(\d{0,6}(?:\.\d{0,4})?).*$/g, '$1')
        .match(/^\d*(\.?\d{0,4})/g)[0] || ''
  }

  if (props?.regExp == 'eight_int_four_dec') {
    val.target.value =
      val.target.value
        .replace(/\D*(\d*)(\.?)(\d{0,8})\d*/, '$1$2$3')
        .replace(/^0+(\d)/, '$1')
        .replace(/^\./, '0.')
        .replace(/^\D*(\d{0,8}(?:\.\d{0,4})?).*$/g, '$1')
        .match(/^\d*(\.?\d{0,8})/g)[0] || ''
  }
  // ...
}
```

- **批量设置费用新增校验功能：**
- **链接查邮箱新增记录时做校验动作：**
- **批量设置费用支持新公式：**

### 文件上传

```vue
<template>
  <div class="component-reconcilia-upload">
    <Dialogs
      v-model="showDialog"
      width="700px"
      size="md"
      class="reconcilia-dialog"
      :title="title"
      :confirmText="confirmText"
      :cancelText="'取消'"
      :destory="doDestory"
      :closeToCancel="true"
      :escapeClose="false"
      :beforeClose="onBeforeClose"
      @onCancel="onCancel"
      @onConfirm="onConfirm"
    >
      <Upload
        ref="uploadRef"
        v-model="formParam[type].upload_reports"
        :list-type="'text'"
        :show-list-type="'row-list'"
        :upload-mode="'progress'"
        :accept="acceptType?.[props?.type]"
        :limit="1048576"
        v-bind="{
          fileType: '',
          isTemporary: false
        }"
        @notice="successNotice"
        @file-change="fileChange"
      />
    </Dialogs>
  </div>
</template>
```
